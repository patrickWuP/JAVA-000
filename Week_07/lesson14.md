>单机MySQL数据库的几个问题

随着数据量的增大，读写并发的增加，系统可用性要求的提升，单机MySQL面临：

1、容量有限，难以扩容。服务是无状态的，系统是有状态的，无法水平扩展。一般单库的TPS不超过5、6千。

2、读写压力，QPS过大，特别是分析类需求会影响到业务事务。

3、可用性不足，宕机问题。


>主从复制

核心是：
1、主库写binlog
2、从库relay log

2000年，MySQL 3.23.15 版本引入了复制

2002年，MySQL 4.0.2版本分离IO和SQL线程，引入了relay log。该版本开始引入了事务。

2010年，MySQL 5.5版本引入半同步复制

2016年，MySQL在5.7.17中引入 InnoDB Group Replication

主从复制原理

binlog格式

-ROW        行，记录的是二进制方式对行数据的修改，日志的量会很大。胜在数据非常详细，更好的还原现场。

-Statement  默认，记录的就是sql本身，记录的数据量很少。没有select相关操作。

-Mixed      混合使用

异步复制：传统主从复制--2000年，MySQL 3.23.15版本引入了Replication
        Primary-Secondary Replication（传统主从复制）
        网络或机器故障，会造成数据不一致
        
半同步复制：保证Source和Replica最终一致性
        主库提交延迟到至少有一个从库响应说拿到了binlog日志。
        
 
组复制：基于分布式Paxos协议实现组复制，保证数据一致性。（MySQL Group Replication MGR）
    
 
ActiveMQ 5个 通过select * from locks for update;保证只被一个机器消费一次，如果其中一个机器down，剩下的机器能够接着消费。

用数据库模拟MQ，用数据库表存要消费的消息。

创建表的黑魔法
create table t3 like t2;

>主从复制的局限性

1、主从延迟问题             [无法解决]

2、应用侧需要配合读写分离框架 []

3、不解决高可用问题 []

>MySQL读写分离

借助于主从复制，我们现在有个多个MySQL服务器示例。

如果借助这个新的集群，改进我们的业务系统数据处理能？

==> 配置多个数据源，实现读写分离

###读写分离-动态切换数据源版本1.0

1、基于Spring/Spring Boot，配置多个数据源(例如2个，master和slave)

2、根据具体的Service方法是否会操作数据，注入不同的数据源，1.0版本

3、改进一下1.1：基于操作AbstractRoutingDataSource和自定义注解readOnly之类的，简化自动切换数据源。

4、改进二下1.2：支持配置多个从库；

5、改进三下1.3：支持多个从库的负载均衡。

###读写分离-数据库框架版本2.0
1、分析前一版本"动态切换数据源"有什么问题？ 
1)侵入性还是较强。
2)降低侵入性会导致“写完读”不一致问题

2、改进方式，ShardingSphere-jdbc的Master-Slave功能
1)SQL解析和事务管理，自动实现读写分离。
2)解决“写完读”不一致的问题

使用ShardingSphere-jdbc 5.0.0-alpha实现读写分离配置。

写完立马去读，如果读操作分配到了从库，这时可能从库还未同步到数据，导致查询不到。

一个事务里，前面的读走从库，只要有一个写，后面的读都走主库以解决以上问题。

###读写分离-数据库中间件版本3.0
1、分析前一版本“框架版本”有什么问题？
1)对业务系统还是有侵入
2)对已存在的旧系统改造不友好

2、改进方式，MyCat/ShardingSphere-Proxy的Master-Slave功能
1)需要部署一个中间件，规则配置在中间件
2)模拟一个MySQL服务器，对业务系统无侵入

DRDS阿里的中间件产品


引入新技术和决策层级也相关。

>高可用定义

高可用意味着，更少的不可服务时间。一般用SLA SLO衡量。
1年 = 365天 = 8760小时

99 = 8760 * 1% = 87.6小时
99.9 = 8760 * 0.1% = 8.76小时
99.99 = 0.876 * 60 = 52.6分钟
99.999 = 8760 * 0.00001 = 0.0876小时 = 5.26分钟

后面的分布式课程讲稳定性，注意关系和区别。

你维护的系统有个9？99.95%算是几个9？

冗余实现高可用系统。使用更高的资源实现更高的可用性。

>为什么要高可用

1、读写分离，提升读的处理能力。

2、故障转移，提供failover能力。从设备转换为主设备。

加上业务侧连接池的心跳重试，实现断线重连，业务不间断，降低RTO和PRO。

什么是failover，故障转移，灾难恢复

容灾：热备与冷备

对于主从来说，简单讲就是主挂了，某一个从变成主。

整个集群来看，正常对外提供服务

常见的一些策略：

1、多个实例不在一个主机/机架上

2、跨机房和可用区部署

3、两地三中心容灾高可用方案

###MySQL高可用0：主从手动切换
如果主节点挂掉，将某个从改成主；

重新配置其他从节点。

修改应用数据源配置。

--->有什么问题？

1、可用数据不一致。

2、需要人工干预。

3、代码和配置的侵入性。

###MySQL高可用1：主从手动切换
用LVS+Keepalive实现多个节点的探活+请求路由。

配置VIP或DNS实现配置不变更。

--->有什么问题?

1、手动处理主从切换。

2、大量的配置和脚本定义。

###MySQL高可用2：MHA

MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司的youshimaton（现在就职于Facebook公司）开发，
是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。

基于Perl语言开发，一般能在30s内实现主从切换。

切换时，直接通过SSH复制主节点的日志。

--->有什么问题?

1、需要配置SSH信息

2、至少3台

MHA Manager 在异步复制时进行主从复制。

###MySQL高可用3：MGR
如果主节点挂掉，将自动选择某个从改成主；

无需人工干预，基于组复制，保证数据一致性。

有什么问题？

1、外部获得状态变更需要读取数据库。

2、外部需要使用LVS/VIP配置。

MGR的特点

1、高一致性：基于分布式Paxos协议实现组复制，保证数据一致性。

2、高容错性：自动检测机制，只要不是大多数节点都宕机就可以继续工作，内置防脑裂保护机制；

3、高扩展性：节点的增加与移除会自动更新组成员信息，新节点加入后，自动从其他节点同步增量数据，直到与其他节点数据一致。

4、高灵活性：提供单主模式和多主模式，单主模式在主库宕机后能够自动选主，所有写入都在主节点进行，多主模式支持多节点写入。

###MySQL高可用4：MySQL Cluster

完整的数据层高可用解决方案

MySQL InnoDB Cluster是一个高可用的框架，它由下面这几个组件构成：

1、MySQL Group Replication：提供DB的扩展、自动故障转移。

2、MySQL Router：轻量级中间件，提供应用程序连接目标的故障转移。

3、MySQL Shell：新的MySQL客户端，多种接口模式。可以设置群组复制及Router；

###MySQL高可用5：Orchestrator
如果主节点挂掉，将某个从改成主；

Orchestrator

一款MySQL高可用和复制拓扑图管理工具，支持复制拓补结构的调整，自动故障转移和手动主从切换等。后端数据库用MySQL或SQLite存储元数据，并提供Web界面展示
MySQL复制的拓补关系及状态，通过web可更改MySQL示例的复制关系和部分配置信息，同时也提供命令行和API接口，方便运维管理。

特点：

1、自动发现MySQL的复制拓扑，并且在web上展示。

2、重构复制关系，可以在web进行拖图进行复制关系变更；

3、检测主异常，并可以自动或手动恢复，通过Hooks进行自定义脚本；

4、支持命令行和web界面管理复制。

基于Go语言开发，实现了中间件本身的高可用

优势：

能直接在UI界面拖拽改变主从关系

